/**
 * ÁªüËÆ°È°µÈù¢
 */

import router from '@ohos.router'
import { Colors, TaskStatus } from '../utils/Constants'
import { DatabaseManager } from '../database/DatabaseManager'
import { Task } from '../models/Task'
import { Statistics } from '../models/User'
import { DateUtils } from '../utils/DateUtils'

@Entry
@Component
struct StatisticsPage {
  @State statistics: Statistics = new Statistics()
  @State recentCompletedTasks: Task[] = []
  @State overdueTasksList: Task[] = []
  private dbManager: DatabaseManager | null = null

  async aboutToAppear() {
    this.dbManager = DatabaseManager.getInstance(getContext(this))
    await this.loadStatistics()
  }

  /**
   * Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
   */
  async loadStatistics() {
    if (!this.dbManager) return

    const allTasks = await this.dbManager.queryAllTasks()
    
    // ËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆ
    this.statistics.totalTasks = allTasks.length
    this.statistics.completedTasks = allTasks.filter(t => t.status === TaskStatus.COMPLETED).length
    this.statistics.inProgressTasks = allTasks.filter(t => t.status === TaskStatus.IN_PROGRESS).length
    this.statistics.notStartedTasks = allTasks.filter(t => t.status === TaskStatus.NOT_STARTED).length
    this.statistics.overdueTasks = allTasks.filter(t => t.isOverdue() && t.status !== TaskStatus.COMPLETED).length
    
    // ËÆ°ÁÆóÂÆåÊàêÁéáÂíåÈÄæÊúüÁéá
    this.statistics.calculateCompletionRate()
    this.statistics.calculateOverdueRate()
    
    // ËÆ°ÁÆóÂπ≥ÂùáÂÆåÊàêÂ§©Êï∞
    const completedTasks = allTasks.filter(t => t.status === TaskStatus.COMPLETED && t.actualFinishTime > 0)
    if (completedTasks.length > 0) {
      const totalDays = completedTasks.reduce((sum, task) => {
        const days = Math.ceil((task.actualFinishTime - task.assignTime) / (1000 * 60 * 60 * 24))
        return sum + days
      }, 0)
      this.statistics.avgCompletionDays = Math.round(totalDays / completedTasks.length)
    }
    
    // Ëé∑ÂèñÊúÄËøëÂÆåÊàêÁöÑ‰ªªÂä°
    this.recentCompletedTasks = completedTasks
      .sort((a, b) => b.actualFinishTime - a.actualFinishTime)
      .slice(0, 5)
    
    // Ëé∑ÂèñÈÄæÊúü‰ªªÂä°
    this.overdueTasksList = allTasks
      .filter(t => t.isOverdue() && t.status !== TaskStatus.COMPLETED)
      .slice(0, 5)
  }

  /**
   * ËøîÂõû‰∏ä‰∏ÄÈ°µ
   */
  goBack() {
    router.back()
  }

  build() {
    Column() {
      // È°∂ÈÉ®ÂØºËà™Ê†è
      Row() {
        Button({ type: ButtonType.Circle }) {
          Text('‚Üê')
            .fontSize(24)
            .fontColor(Colors.TEXT_WHITE)
        }
        .width(40)
        .height(40)
        .backgroundColor('rgba(255, 255, 255, 0.2)')
        .onClick(() => this.goBack())

        Text('Êï∞ÊçÆÁªüËÆ°')
          .fontSize(22)
          .fontWeight(600)
          .fontColor(Colors.TEXT_WHITE)
          .margin({ left: 15 })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 15, bottom: 15 })
      .linearGradient({
        angle: 135,
        colors: [[Colors.BG_GRADIENT_START, 0.0], [Colors.BG_GRADIENT_END, 1.0]]
      })

      Scroll() {
        Column() {
          // ÊÄªËßàÂç°Áâá
          Column() {
            Text('‰ªªÂä°ÊÄªËßà')
              .fontSize(18)
              .fontWeight(600)
              .fontColor(Colors.TEXT_PRIMARY)
              .width('100%')
              .margin({ bottom: 20 })

            Row() {
              this.StatItem('ÂÖ®ÈÉ®‰ªªÂä°', this.statistics.totalTasks, 'üìã')
              this.StatItem('Â∑≤ÂÆåÊàê', this.statistics.completedTasks, '‚úÖ')
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .margin({ bottom: 15 })

            Row() {
              this.StatItem('ËøõË°å‰∏≠', this.statistics.inProgressTasks, '‚ö°')
              this.StatItem('Â∑≤ÈÄæÊúü', this.statistics.overdueTasks, '‚ö†Ô∏è')
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }
          .width('100%')
          .padding(18)
          .backgroundColor(Colors.BG_CARD)
          .borderRadius(16)
          .shadow({
            radius: 10,
            color: 'rgba(0, 0, 0, 0.08)',
            offsetX: 0,
            offsetY: 2
          })
          .margin({ bottom: 20 })

          // ÂÆåÊàêÁéáÂç°Áâá
          Column() {
            Text('ÂÆåÊàêÁéáÂàÜÊûê')
              .fontSize(18)
              .fontWeight(600)
              .fontColor(Colors.TEXT_PRIMARY)
              .width('100%')
              .margin({ bottom: 20 })

            // ÂÆåÊàêÁéáÁéØÂΩ¢ÂõæÔºàÁÆÄÂåñÁâàÔºâ
            Column() {
              Text(`${this.statistics.completionRate}%`)
                .fontSize(48)
                .fontWeight(700)
                .fontColor(Colors.PRIMARY_START)
                .margin({ bottom: 8 })
              
              Text('‰ªªÂä°ÂÆåÊàêÁéá')
                .fontSize(14)
                .fontColor(Colors.TEXT_SECONDARY)
            }
            .width('100%')
            .height(160)
            .justifyContent(FlexAlign.Center)
            .backgroundColor('rgba(102, 126, 234, 0.05)')
            .borderRadius(12)
            .margin({ bottom: 15 })

            // ËøõÂ∫¶Êù°
            Column() {
              Row() {
                Text('ÂÆåÊàêËøõÂ∫¶')
                  .fontSize(14)
                  .fontColor(Colors.TEXT_SECONDARY)
                
                Blank()
                
                Text(`${this.statistics.completedTasks}/${this.statistics.totalTasks}`)
                  .fontSize(14)
                  .fontColor(Colors.TEXT_PRIMARY)
                  .fontWeight(600)
              }
              .width('100%')
              .margin({ bottom: 8 })

              Row() {
                Row()
                  .width(`${this.statistics.completionRate}%`)
                  .height('100%')
                  .backgroundColor(Colors.STATUS_COMPLETED)
                  .borderRadius(6)
              }
              .width('100%')
              .height(12)
              .backgroundColor(Colors.BG_PRIMARY)
              .borderRadius(6)
            }
            .width('100%')
          }
          .width('100%')
          .padding(18)
          .backgroundColor(Colors.BG_CARD)
          .borderRadius(16)
          .shadow({
            radius: 10,
            color: 'rgba(0, 0, 0, 0.08)',
            offsetX: 0,
            offsetY: 2
          })
          .margin({ bottom: 20 })

          // ÊïàÁéáÊåáÊ†á
          Column() {
            Text('ÊïàÁéáÊåáÊ†á')
              .fontSize(18)
              .fontWeight(600)
              .fontColor(Colors.TEXT_PRIMARY)
              .width('100%')
              .margin({ bottom: 15 })

            Row() {
              Column() {
                Text('‚è±Ô∏è')
                  .fontSize(32)
                  .margin({ bottom: 8 })
                
                Text(`${this.statistics.avgCompletionDays}Â§©`)
                  .fontSize(24)
                  .fontWeight(700)
                  .fontColor(Colors.TEXT_PRIMARY)
                  .margin({ bottom: 4 })
                
                Text('Âπ≥ÂùáÂÆåÊàêÊó∂Èïø')
                  .fontSize(13)
                  .fontColor(Colors.TEXT_SECONDARY)
              }
              .layoutWeight(1)
              .padding(15)
              .backgroundColor('rgba(52, 152, 219, 0.08)')
              .borderRadius(12)

              Column() {
                Text('üìä')
                  .fontSize(32)
                  .margin({ bottom: 8 })
                
                Text(`${this.statistics.overdueRate}%`)
                  .fontSize(24)
                  .fontWeight(700)
                  .fontColor(this.statistics.overdueRate > 20 ? Colors.STATUS_OVERDUE : Colors.TEXT_PRIMARY)
                  .margin({ bottom: 4 })
                
                Text('ÈÄæÊúüÁéá')
                  .fontSize(13)
                  .fontColor(Colors.TEXT_SECONDARY)
              }
              .layoutWeight(1)
              .padding(15)
              .backgroundColor('rgba(231, 76, 60, 0.08)')
              .borderRadius(12)
              .margin({ left: 12 })
            }
            .width('100%')
          }
          .width('100%')
          .padding(18)
          .backgroundColor(Colors.BG_CARD)
          .borderRadius(16)
          .shadow({
            radius: 10,
            color: 'rgba(0, 0, 0, 0.08)',
            offsetX: 0,
            offsetY: 2
          })
          .margin({ bottom: 20 })

          // ÊúÄËøëÂÆåÊàê
          if (this.recentCompletedTasks.length > 0) {
            Column() {
              Text('ÊúÄËøëÂÆåÊàê')
                .fontSize(18)
                .fontWeight(600)
                .fontColor(Colors.TEXT_PRIMARY)
                .width('100%')
                .margin({ bottom: 15 })

              Column({ space: 10 }) {
                ForEach(this.recentCompletedTasks, (task: Task) => {
                  this.CompletedTaskItem(task)
                })
              }
              .width('100%')
            }
            .width('100%')
            .padding(18)
            .backgroundColor(Colors.BG_CARD)
            .borderRadius(16)
            .shadow({
              radius: 10,
              color: 'rgba(0, 0, 0, 0.08)',
              offsetX: 0,
              offsetY: 2
            })
            .margin({ bottom: 20 })
          }

          // ÈÄæÊúü‰ªªÂä°
          if (this.overdueTasksList.length > 0) {
            Column() {
              Row() {
                Text('ÈÄæÊúü‰ªªÂä°')
                  .fontSize(18)
                  .fontWeight(600)
                  .fontColor(Colors.STATUS_OVERDUE)
                
                Text(`${this.overdueTasksList.length}`)
                  .fontSize(16)
                  .fontColor(Colors.TEXT_WHITE)
                  .padding({ left: 8, right: 8, top: 3, bottom: 3 })
                  .backgroundColor(Colors.STATUS_OVERDUE)
                  .borderRadius(10)
                  .margin({ left: 10 })
              }
              .width('100%')
              .margin({ bottom: 15 })

              Column({ space: 10 }) {
                ForEach(this.overdueTasksList, (task: Task) => {
                  this.OverdueTaskItem(task)
                })
              }
              .width('100%')
            }
            .width('100%')
            .padding(18)
            .backgroundColor(Colors.BG_CARD)
            .borderRadius(16)
            .shadow({
              radius: 10,
              color: 'rgba(0, 0, 0, 0.08)',
              offsetX: 0,
              offsetY: 2
            })
            .margin({ bottom: 20 })
          }

          // ÊèêÁ§∫‰ø°ÊÅØ
          Row() {
            Text('üí°')
              .fontSize(18)
              .margin({ right: 10 })
            
            Column() {
              Text('Êï∞ÊçÆÊõ¥Êñ∞Êó∂Èó¥')
                .fontSize(12)
                .fontColor(Colors.TEXT_LIGHT)
                .margin({ bottom: 3 })
              
              Text(DateUtils.formatDate(DateUtils.now(), 'YYYY-MM-DD HH:mm'))
                .fontSize(13)
                .fontColor(Colors.TEXT_SECONDARY)
            }
            .alignItems(HorizontalAlign.Start)
          }
          .width('100%')
          .padding(15)
          .backgroundColor('rgba(149, 165, 166, 0.08)')
          .borderRadius(12)
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 20, bottom: 20 })
      }
      .layoutWeight(1)
      .backgroundColor(Colors.BG_PRIMARY)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Colors.BG_PRIMARY)
  }

  /**
   * ÁªüËÆ°È°πÁªÑ‰ª∂
   */
  @Builder
  StatItem(label: string, value: number, icon: string) {
    Column() {
      Text(icon)
        .fontSize(28)
        .margin({ bottom: 8 })
      
      Text(value.toString())
        .fontSize(26)
        .fontWeight(700)
        .fontColor(Colors.TEXT_PRIMARY)
        .margin({ bottom: 4 })
      
      Text(label)
        .fontSize(13)
        .fontColor(Colors.TEXT_SECONDARY)
    }
    .width('48%')
    .height(110)
    .backgroundColor(Colors.BG_PRIMARY)
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
  }

  /**
   * Â∑≤ÂÆåÊàê‰ªªÂä°È°π
   */
  @Builder
  CompletedTaskItem(task: Task) {
    Row() {
      Column() {
        Text(task.taskName)
          .fontSize(14)
          .fontWeight(500)
          .fontColor(Colors.TEXT_PRIMARY)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 4 })
        
        Text(`${task.assigneeName} ¬∑ ${DateUtils.formatDate(task.actualFinishTime, 'MMÊúàDDÊó•')}ÂÆåÊàê`)
          .fontSize(12)
          .fontColor(Colors.TEXT_SECONDARY)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Text('‚úì')
        .fontSize(20)
        .fontColor(Colors.STATUS_COMPLETED)
        .fontWeight(700)
    }
    .width('100%')
    .padding(12)
    .backgroundColor(Colors.BG_PRIMARY)
    .borderRadius(10)
  }

  /**
   * ÈÄæÊúü‰ªªÂä°È°π
   */
  @Builder
  OverdueTaskItem(task: Task) {
    Row() {
      Column() {
        Text(task.taskName)
          .fontSize(14)
          .fontWeight(500)
          .fontColor(Colors.TEXT_PRIMARY)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 4 })
        
        Text(`${task.assigneeName} ¬∑ ${DateUtils.getRemainingTimeText(task.planFinishTime)}`)
          .fontSize(12)
          .fontColor(Colors.STATUS_OVERDUE)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Text('!')
        .fontSize(20)
        .fontColor(Colors.STATUS_OVERDUE)
        .fontWeight(700)
    }
    .width('100%')
    .padding(12)
    .backgroundColor('rgba(231, 76, 60, 0.05)')
    .borderRadius(10)
    .border({
      width: 1,
      color: 'rgba(231, 76, 60, 0.2)',
      radius: 10
    })
  }
}

