/**
 * åé¦ˆé¡µé¢
 */

import router from '@ohos.router'
import { Colors, FeedbackType } from '../utils/Constants'
import { DatabaseManager } from '../database/DatabaseManager'
import { Feedback } from '../models/Feedback'
import { DateUtils } from '../utils/DateUtils'
import promptAction from '@ohos.promptAction'

@Entry
@Component
struct FeedbackPage {
  @State feedbackContent: string = ''
  @State selectedType: string = FeedbackType.PROGRESS
  @State feedbackPerson: string = ''
  @State isSubmitting: boolean = false
  private taskId: number = 0
  private taskName: string = ''
  private dbManager: DatabaseManager | null = null

  async aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>
    if (params) {
      this.taskId = params.taskId as number
      this.taskName = params.taskName as string
    }

    // åˆå§‹åŒ–æ•°æ®åº“
    this.dbManager = DatabaseManager.getInstance(getContext(this))
  }

  /**
   * éªŒè¯è¡¨å•
   */
  validateForm(): boolean {
    if (!this.feedbackPerson.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥åé¦ˆäººå§“å', duration: 2000 })
      return false
    }
    
    if (!this.feedbackContent.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥åé¦ˆå†…å®¹', duration: 2000 })
      return false
    }
    
    return true
  }

  /**
   * æäº¤åé¦ˆ
   */
  async submitFeedback() {
    if (!this.validateForm()) {
      return
    }

    if (this.isSubmitting) {
      return
    }

    this.isSubmitting = true

    const feedback = new Feedback({
      taskId: this.taskId,
      feedbackContent: this.feedbackContent.trim(),
      feedbackTime: DateUtils.now(),
      feedbackType: this.selectedType,
      feedbackPerson: this.feedbackPerson.trim(),
      isRead: 0
    })

    if (this.dbManager) {
      const feedbackId = await this.dbManager.insertFeedback(feedback)
      
      if (feedbackId > 0) {
        promptAction.showToast({ message: 'åé¦ˆæäº¤æˆåŠŸ', duration: 2000 })
        
        setTimeout(() => {
          router.back()
        }, 500)
      } else {
        promptAction.showToast({ message: 'åé¦ˆæäº¤å¤±è´¥', duration: 2000 })
        this.isSubmitting = false
      }
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  goBack() {
    router.back()
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle }) {
          Text('â†')
            .fontSize(24)
            .fontColor(Colors.TEXT_WHITE)
        }
        .width(40)
        .height(40)
        .backgroundColor('rgba(255, 255, 255, 0.2)')
        .onClick(() => this.goBack())

        Column() {
          Text('æ·»åŠ åé¦ˆ')
            .fontSize(22)
            .fontWeight(600)
            .fontColor(Colors.TEXT_WHITE)
          
          if (this.taskName) {
            Text(this.taskName)
              .fontSize(13)
              .fontColor('rgba(255, 255, 255, 0.85)')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .margin({ top: 3 })
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        .margin({ left: 15 })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 15, bottom: 15 })
      .linearGradient({
        angle: 135,
        colors: [[Colors.BG_GRADIENT_START, 0.0], [Colors.BG_GRADIENT_END, 1.0]]
      })

      // è¡¨å•å†…å®¹
      Scroll() {
        Column() {
          // åé¦ˆäºº
          this.FormSection('åé¦ˆäºº', true)
          TextInput({ placeholder: 'è¯·è¾“å…¥æ‚¨çš„å§“å' })
            .width('100%')
            .height(50)
            .fontSize(15)
            .backgroundColor(Colors.BG_CARD)
            .borderRadius(12)
            .margin({ bottom: 20 })
            .onChange((value: string) => {
              this.feedbackPerson = value
            })

          // åé¦ˆç±»å‹
          this.FormSection('åé¦ˆç±»å‹', true)
          Row() {
            this.TypeChip(FeedbackType.PROGRESS)
            this.TypeChip(FeedbackType.ISSUE)
            this.TypeChip(FeedbackType.COMPLETION)
            this.TypeChip(FeedbackType.QUESTION)
          }
          .width('100%')
          .margin({ bottom: 20 })

          // åé¦ˆå†…å®¹
          this.FormSection('åé¦ˆå†…å®¹', true)
          TextArea({ placeholder: 'è¯·è¯¦ç»†æè¿°æ‚¨çš„åé¦ˆå†…å®¹...\n\nä¾‹å¦‚ï¼š\n- å½“å‰è¿›åº¦å’Œå®Œæˆæƒ…å†µ\n- é‡åˆ°çš„é—®é¢˜å’Œå›°éš¾\n- éœ€è¦çš„æ”¯æŒå’Œèµ„æº\n- ä¸‹ä¸€æ­¥è®¡åˆ’' })
            .width('100%')
            .height(280)
            .fontSize(15)
            .backgroundColor(Colors.BG_CARD)
            .borderRadius(12)
            .margin({ bottom: 20 })
            .onChange((value: string) => {
              this.feedbackContent = value
            })

          // æç¤ºä¿¡æ¯
          Row() {
            Text('ğŸ’¡')
              .fontSize(16)
              .margin({ right: 8 })
            
            Text('åŠæ—¶åé¦ˆæœ‰åŠ©äºä»»åŠ¡é¡ºåˆ©æ¨è¿›')
              .fontSize(13)
              .fontColor(Colors.TEXT_SECONDARY)
              .lineHeight(20)
          }
          .width('100%')
          .padding(12)
          .backgroundColor('rgba(102, 126, 234, 0.08)')
          .borderRadius(10)
          .margin({ bottom: 30 })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 20, bottom: 20 })
      }
      .layoutWeight(1)
      .backgroundColor(Colors.BG_PRIMARY)

      // æäº¤æŒ‰é’®
      Button(this.isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤åé¦ˆ')
        .width('90%')
        .height(50)
        .fontSize(18)
        .fontWeight(600)
        .backgroundColor(this.isSubmitting ? Colors.TEXT_LIGHT : Colors.PRIMARY_START)
        .borderRadius(25)
        .margin({ top: 10, bottom: 20 })
        .enabled(!this.isSubmitting)
        .onClick(() => this.submitFeedback())
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Colors.BG_PRIMARY)
  }

  /**
   * è¡¨å•æ ‡é¢˜ç»„ä»¶
   */
  @Builder
  FormSection(title: string, required: boolean) {
    Row() {
      Text(title)
        .fontSize(15)
        .fontWeight(600)
        .fontColor(Colors.TEXT_PRIMARY)
      
      if (required) {
        Text(' *')
          .fontSize(15)
          .fontColor(Colors.STATUS_OVERDUE)
      }
    }
    .margin({ bottom: 10 })
  }

  /**
   * ç±»å‹é€‰æ‹©ç»„ä»¶
   */
  @Builder
  TypeChip(type: string) {
    Text(type)
      .fontSize(13)
      .fontColor(this.selectedType === type ? Colors.TEXT_WHITE : Colors.TEXT_PRIMARY)
      .padding({ left: 14, right: 14, top: 9, bottom: 9 })
      .backgroundColor(this.selectedType === type ? Colors.PRIMARY_START : Colors.BG_CARD)
      .borderRadius(18)
      .border({
        width: this.selectedType === type ? 0 : 1,
        color: Colors.TEXT_LIGHT
      })
      .margin({ right: 8, bottom: 8 })
      .onClick(() => {
        this.selectedType = type
      })
  }
}

