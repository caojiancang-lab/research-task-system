/**
 * ä»»åŠ¡è¯¦æƒ…é¡µé¢
 */

import router from '@ohos.router'
import { Colors, TaskStatus } from '../utils/Constants'
import { DatabaseManager } from '../database/DatabaseManager'
import { Task } from '../models/Task'
import { Feedback } from '../models/Feedback'
import { DateUtils } from '../utils/DateUtils'
import promptAction from '@ohos.promptAction'

@Entry
@Component
struct TaskDetail {
  @State task: Task | null = null
  @State feedbacks: Feedback[] = []
  @State showDeleteDialog: boolean = false
  @State showStatusDialog: boolean = false
  private taskId: number = 0
  private dbManager: DatabaseManager | null = null

  async aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>
    if (params && params.taskId) {
      this.taskId = params.taskId as number
    }

    // åˆå§‹åŒ–æ•°æ®åº“
    this.dbManager = DatabaseManager.getInstance(getContext(this))
    await this.loadTaskDetail()
    await this.loadFeedbacks()
  }

  /**
   * åŠ è½½ä»»åŠ¡è¯¦æƒ…
   */
  async loadTaskDetail() {
    if (!this.dbManager) return

    this.task = await this.dbManager.queryTaskById(this.taskId)
  }

  /**
   * åŠ è½½åé¦ˆåˆ—è¡¨
   */
  async loadFeedbacks() {
    if (!this.dbManager) return

    this.feedbacks = await this.dbManager.queryFeedbacksByTaskId(this.taskId)
  }

  /**
   * æ›´æ–°ä»»åŠ¡çŠ¶æ€
   */
  async updateTaskStatus(newStatus: string) {
    if (!this.task || !this.dbManager) return

    this.task.status = newStatus
    this.task.updateTime = DateUtils.now()
    
    // å¦‚æœæ ‡è®°ä¸ºå®Œæˆï¼Œè®°å½•å®Œæˆæ—¶é—´
    if (newStatus === TaskStatus.COMPLETED) {
      this.task.actualFinishTime = DateUtils.now()
    }

    const success = await this.dbManager.updateTask(this.task)
    
    if (success) {
      promptAction.showToast({ message: 'çŠ¶æ€æ›´æ–°æˆåŠŸ', duration: 2000 })
      await this.loadTaskDetail()
    } else {
      promptAction.showToast({ message: 'çŠ¶æ€æ›´æ–°å¤±è´¥', duration: 2000 })
    }
    
    this.showStatusDialog = false
  }

  /**
   * åˆ é™¤ä»»åŠ¡
   */
  async deleteTask() {
    if (!this.dbManager) return

    const success = await this.dbManager.deleteTask(this.taskId)
    
    if (success) {
      promptAction.showToast({ message: 'ä»»åŠ¡å·²åˆ é™¤', duration: 2000 })
      setTimeout(() => {
        router.back()
      }, 500)
    } else {
      promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥', duration: 2000 })
    }
    
    this.showDeleteDialog = false
  }

  /**
   * å¯¼èˆªåˆ°ç¼–è¾‘é¡µé¢
   */
  navigateToEdit() {
    router.pushUrl({
      url: 'pages/TaskEdit',
      params: { taskId: this.taskId }
    })
  }

  /**
   * å¯¼èˆªåˆ°åé¦ˆé¡µé¢
   */
  navigateToFeedback() {
    router.pushUrl({
      url: 'pages/FeedbackPage',
      params: { taskId: this.taskId, taskName: this.task?.taskName }
    })
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  goBack() {
    router.back()
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle }) {
          Text('â†')
            .fontSize(24)
            .fontColor(Colors.TEXT_WHITE)
        }
        .width(40)
        .height(40)
        .backgroundColor('rgba(255, 255, 255, 0.2)')
        .onClick(() => this.goBack())

        Text('ä»»åŠ¡è¯¦æƒ…')
          .fontSize(22)
          .fontWeight(600)
          .fontColor(Colors.TEXT_WHITE)
          .margin({ left: 15 })
        
        Blank()

        Button({ type: ButtonType.Circle }) {
          Text('âœï¸')
            .fontSize(18)
        }
        .width(40)
        .height(40)
        .backgroundColor('rgba(255, 255, 255, 0.2)')
        .onClick(() => this.navigateToEdit())

        Button({ type: ButtonType.Circle }) {
          Text('ğŸ—‘ï¸')
            .fontSize(18)
        }
        .width(40)
        .height(40)
        .backgroundColor('rgba(255, 255, 255, 0.2)')
        .margin({ left: 10 })
        .onClick(() => this.showDeleteDialog = true)
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 15, bottom: 15 })
      .linearGradient({
        angle: 135,
        colors: [[Colors.BG_GRADIENT_START, 0.0], [Colors.BG_GRADIENT_END, 1.0]]
      })

      if (this.task) {
        Scroll() {
          Column() {
            // ä»»åŠ¡åŸºæœ¬ä¿¡æ¯å¡ç‰‡
            Column() {
              // ä»»åŠ¡åç§°å’ŒçŠ¶æ€
              Row() {
                Text(this.task.taskName)
                  .fontSize(20)
                  .fontWeight(700)
                  .fontColor(Colors.TEXT_PRIMARY)
                  .layoutWeight(1)
                  .maxLines(3)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                
                Text(this.task.status)
                  .fontSize(13)
                  .fontColor(Colors.TEXT_WHITE)
                  .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                  .backgroundColor(this.getStatusColor(this.task.status))
                  .borderRadius(12)
                  .margin({ left: 10 })
                  .onClick(() => this.showStatusDialog = true)
              }
              .width('100%')
              .margin({ bottom: 15 })

              // ä¼˜å…ˆçº§
              Row() {
                Text('ä¼˜å…ˆçº§')
                  .fontSize(14)
                  .fontColor(Colors.TEXT_SECONDARY)
                
                Blank()
                
                Text(this.task.priority)
                  .fontSize(13)
                  .fontColor(this.getPriorityColor(this.task.priority))
                  .fontWeight(600)
                  .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                  .border({
                    width: 1.5,
                    color: this.getPriorityColor(this.task.priority),
                    radius: 10
                  })
              }
              .width('100%')
              .margin({ bottom: 12 })

              Divider().color(Colors.BG_PRIMARY).margin({ top: 5, bottom: 15 })

              // äººå‘˜ä¿¡æ¯
              this.InfoRow('ğŸ‘¤ æŒ‡æ´¾äºº', this.task.assignerName)
              this.InfoRow('ğŸ¯ æ‰§è¡Œäºº', this.task.assigneeName)

              Divider().color(Colors.BG_PRIMARY).margin({ top: 15, bottom: 15 })

              // æ—¶é—´ä¿¡æ¯
              this.InfoRow('ğŸ“… æŒ‡æ´¾æ—¶é—´', DateUtils.formatDate(this.task.assignTime, 'YYYY-MM-DD HH:mm'))
              this.InfoRow('â° è®¡åˆ’å®Œæˆ', DateUtils.formatDate(this.task.planFinishTime, 'YYYY-MM-DD'))
              
              if (this.task.actualFinishTime > 0) {
                this.InfoRow('âœ… å®é™…å®Œæˆ', DateUtils.formatDate(this.task.actualFinishTime, 'YYYY-MM-DD HH:mm'))
              } else {
                Row() {
                  Text('â³ å‰©ä½™æ—¶é—´')
                    .fontSize(14)
                    .fontColor(Colors.TEXT_SECONDARY)
                  
                  Blank()
                  
                  Text(DateUtils.getRemainingTimeText(this.task.planFinishTime))
                    .fontSize(14)
                    .fontColor(this.task.isOverdue() ? Colors.STATUS_OVERDUE : Colors.TEXT_PRIMARY)
                    .fontWeight(600)
                }
                .width('100%')
                .margin({ bottom: 12 })
              }

              // ä»»åŠ¡æè¿°
              if (this.task.taskDescription) {
                Divider().color(Colors.BG_PRIMARY).margin({ top: 5, bottom: 15 })
                
                Text('ä»»åŠ¡è¦æ±‚')
                  .fontSize(15)
                  .fontWeight(600)
                  .fontColor(Colors.TEXT_PRIMARY)
                  .width('100%')
                  .margin({ bottom: 10 })
                
                Text(this.task.taskDescription)
                  .fontSize(14)
                  .fontColor(Colors.TEXT_SECONDARY)
                  .lineHeight(22)
                  .width('100%')
              }

              // æ ‡ç­¾
              if (this.task.tags) {
                Divider().color(Colors.BG_PRIMARY).margin({ top: 15, bottom: 15 })
                
                Text('æ ‡ç­¾')
                  .fontSize(15)
                  .fontWeight(600)
                  .fontColor(Colors.TEXT_PRIMARY)
                  .width('100%')
                  .margin({ bottom: 10 })
                
                Row() {
                  ForEach(this.task.tags.split(','), (tag: string) => {
                    if (tag.trim()) {
                      Text(tag.trim())
                        .fontSize(12)
                        .fontColor(Colors.PRIMARY_START)
                        .padding({ left: 10, right: 10, top: 5, bottom: 5 })
                        .backgroundColor('rgba(102, 126, 234, 0.1)')
                        .borderRadius(10)
                        .margin({ right: 8, bottom: 8 })
                    }
                  })
                }
                .width('100%')
              }

              // å¤‡æ³¨
              if (this.task.remarks) {
                Divider().color(Colors.BG_PRIMARY).margin({ top: 10, bottom: 15 })
                
                Text('å¤‡æ³¨')
                  .fontSize(15)
                  .fontWeight(600)
                  .fontColor(Colors.TEXT_PRIMARY)
                  .width('100%')
                  .margin({ bottom: 10 })
                
                Text(this.task.remarks)
                  .fontSize(14)
                  .fontColor(Colors.TEXT_SECONDARY)
                  .lineHeight(22)
                  .width('100%')
              }
            }
            .width('100%')
            .padding(18)
            .backgroundColor(Colors.BG_CARD)
            .borderRadius(16)
            .shadow({
              radius: 10,
              color: 'rgba(0, 0, 0, 0.08)',
              offsetX: 0,
              offsetY: 2
            })
            .margin({ bottom: 20 })

            // åé¦ˆè®°å½•
            Row() {
              Text('åé¦ˆè®°å½•')
                .fontSize(18)
                .fontWeight(600)
                .fontColor(Colors.TEXT_PRIMARY)
              
              Text(`(${this.feedbacks.length})`)
                .fontSize(16)
                .fontColor(Colors.TEXT_SECONDARY)
                .margin({ left: 6 })
              
              Blank()
              
              Button('æ·»åŠ åé¦ˆ')
                .fontSize(14)
                .fontColor(Colors.TEXT_WHITE)
                .backgroundColor(Colors.PRIMARY_START)
                .height(35)
                .borderRadius(18)
                .onClick(() => this.navigateToFeedback())
            }
            .width('100%')
            .margin({ bottom: 15 })

            // åé¦ˆåˆ—è¡¨
            if (this.feedbacks.length === 0) {
              Column() {
                Text('ğŸ’¬')
                  .fontSize(50)
                  .margin({ bottom: 10 })
                
                Text('æš‚æ— åé¦ˆ')
                  .fontSize(15)
                  .fontColor(Colors.TEXT_SECONDARY)
                
                Text('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ åé¦ˆ')
                  .fontSize(13)
                  .fontColor(Colors.TEXT_LIGHT)
                  .margin({ top: 6 })
              }
              .width('100%')
              .height(180)
              .backgroundColor(Colors.BG_CARD)
              .borderRadius(16)
              .justifyContent(FlexAlign.Center)
            } else {
              Column({ space: 12 }) {
                ForEach(this.feedbacks, (feedback: Feedback) => {
                  this.FeedbackCard(feedback)
                })
              }
              .width('100%')
            }
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 20, bottom: 20 })
        }
        .layoutWeight(1)
        .backgroundColor(Colors.BG_PRIMARY)
      }

      // åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
      if (this.showDeleteDialog) {
        this.DeleteDialog()
      }

      // çŠ¶æ€ä¿®æ”¹å¯¹è¯æ¡†
      if (this.showStatusDialog) {
        this.StatusDialog()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Colors.BG_PRIMARY)
  }

  /**
   * ä¿¡æ¯è¡Œç»„ä»¶
   */
  @Builder
  InfoRow(label: string, value: string) {
    Row() {
      Text(label)
        .fontSize(14)
        .fontColor(Colors.TEXT_SECONDARY)
      
      Blank()
      
      Text(value)
        .fontSize(14)
        .fontColor(Colors.TEXT_PRIMARY)
        .fontWeight(500)
    }
    .width('100%')
    .margin({ bottom: 12 })
  }

  /**
   * åé¦ˆå¡ç‰‡ç»„ä»¶
   */
  @Builder
  FeedbackCard(feedback: Feedback) {
    Column() {
      Row() {
        Text(feedback.feedbackPerson)
          .fontSize(15)
          .fontWeight(600)
          .fontColor(Colors.TEXT_PRIMARY)
        
        Text(feedback.feedbackType)
          .fontSize(11)
          .fontColor(Colors.PRIMARY_START)
          .padding({ left: 8, right: 8, top: 3, bottom: 3 })
          .backgroundColor('rgba(102, 126, 234, 0.1)')
          .borderRadius(8)
          .margin({ left: 10 })
        
        Blank()
        
        Text(DateUtils.getFriendlyTime(feedback.feedbackTime))
          .fontSize(12)
          .fontColor(Colors.TEXT_LIGHT)
      }
      .width('100%')
      .margin({ bottom: 10 })

      Text(feedback.feedbackContent)
        .fontSize(14)
        .fontColor(Colors.TEXT_SECONDARY)
        .lineHeight(22)
        .width('100%')

      // å›å¤å†…å®¹
      if (feedback.hasReply()) {
        Column() {
          Row() {
            Text('ğŸ’¬ ' + feedback.replyPerson + ' å›å¤')
              .fontSize(13)
              .fontColor(Colors.TEXT_SECONDARY)
            
            Blank()
            
            Text(DateUtils.getFriendlyTime(feedback.replyTime))
              .fontSize(11)
              .fontColor(Colors.TEXT_LIGHT)
          }
          .width('100%')
          .margin({ bottom: 8 })

          Text(feedback.replyContent)
            .fontSize(13)
            .fontColor(Colors.TEXT_SECONDARY)
            .lineHeight(20)
            .width('100%')
        }
        .width('100%')
        .padding(12)
        .backgroundColor(Colors.BG_PRIMARY)
        .borderRadius(10)
        .margin({ top: 10 })
      }
    }
    .width('100%')
    .padding(15)
    .backgroundColor(Colors.BG_CARD)
    .borderRadius(12)
    .shadow({
      radius: 6,
      color: 'rgba(0, 0, 0, 0.06)',
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
   */
  @Builder
  DeleteDialog() {
    Column() {
      Column() {
        Text('ç¡®è®¤åˆ é™¤')
          .fontSize(18)
          .fontWeight(600)
          .fontColor(Colors.TEXT_PRIMARY)
          .margin({ bottom: 15 })
        
        Text('åˆ é™¤åå°†æ— æ³•æ¢å¤ï¼Œç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')
          .fontSize(14)
          .fontColor(Colors.TEXT_SECONDARY)
          .lineHeight(22)
          .margin({ bottom: 25 })
        
        Row() {
          Button('å–æ¶ˆ')
            .fontSize(15)
            .fontColor(Colors.TEXT_SECONDARY)
            .backgroundColor(Colors.BG_PRIMARY)
            .layoutWeight(1)
            .height(45)
            .onClick(() => this.showDeleteDialog = false)
          
          Button('åˆ é™¤')
            .fontSize(15)
            .fontColor(Colors.TEXT_WHITE)
            .backgroundColor(Colors.STATUS_OVERDUE)
            .layoutWeight(1)
            .height(45)
            .margin({ left: 12 })
            .onClick(() => this.deleteTask())
        }
        .width('100%')
      }
      .width('85%')
      .padding(20)
      .backgroundColor(Colors.BG_CARD)
      .borderRadius(16)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0, 0, 0, 0.5)')
    .justifyContent(FlexAlign.Center)
    .onClick(() => this.showDeleteDialog = false)
  }

  /**
   * çŠ¶æ€ä¿®æ”¹å¯¹è¯æ¡†
   */
  @Builder
  StatusDialog() {
    Column() {
      Column() {
        Text('ä¿®æ”¹çŠ¶æ€')
          .fontSize(18)
          .fontWeight(600)
          .fontColor(Colors.TEXT_PRIMARY)
          .margin({ bottom: 20 })
        
        this.StatusOption(TaskStatus.NOT_STARTED)
        this.StatusOption(TaskStatus.IN_PROGRESS)
        this.StatusOption(TaskStatus.COMPLETED)
        this.StatusOption(TaskStatus.OVERDUE)
        
        Button('å–æ¶ˆ')
          .fontSize(15)
          .fontColor(Colors.TEXT_SECONDARY)
          .backgroundColor(Colors.BG_PRIMARY)
          .width('100%')
          .height(45)
          .margin({ top: 15 })
          .onClick(() => this.showStatusDialog = false)
      }
      .width('85%')
      .padding(20)
      .backgroundColor(Colors.BG_CARD)
      .borderRadius(16)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0, 0, 0, 0.5)')
    .justifyContent(FlexAlign.Center)
    .onClick(() => this.showStatusDialog = false)
  }

  /**
   * çŠ¶æ€é€‰é¡¹
   */
  @Builder
  StatusOption(status: string) {
    Row() {
      Text(status)
        .fontSize(15)
        .fontColor(Colors.TEXT_PRIMARY)
      
      Blank()
      
      if (this.task && this.task.status === status) {
        Text('âœ“')
          .fontSize(18)
          .fontColor(Colors.PRIMARY_START)
          .fontWeight(700)
      }
    }
    .width('100%')
    .height(50)
    .padding({ left: 15, right: 15 })
    .backgroundColor(this.task && this.task.status === status ? 'rgba(102, 126, 234, 0.1)' : Colors.BG_PRIMARY)
    .borderRadius(10)
    .margin({ bottom: 10 })
    .onClick(() => this.updateTaskStatus(status))
  }

  /**
   * è·å–çŠ¶æ€é¢œè‰²
   */
  getStatusColor(status: string): string {
    switch (status) {
      case TaskStatus.NOT_STARTED:
        return Colors.STATUS_NOT_STARTED
      case TaskStatus.IN_PROGRESS:
        return Colors.STATUS_IN_PROGRESS
      case TaskStatus.COMPLETED:
        return Colors.STATUS_COMPLETED
      case TaskStatus.OVERDUE:
        return Colors.STATUS_OVERDUE
      default:
        return Colors.STATUS_NOT_STARTED
    }
  }

  /**
   * è·å–ä¼˜å…ˆçº§é¢œè‰²
   */
  getPriorityColor(priority: string): string {
    switch (priority) {
      case 'ä½':
        return Colors.PRIORITY_LOW
      case 'ä¸­':
        return Colors.PRIORITY_MEDIUM
      case 'é«˜':
        return Colors.PRIORITY_HIGH
      case 'ç´§æ€¥':
        return Colors.PRIORITY_URGENT
      default:
        return Colors.PRIORITY_MEDIUM
    }
  }
}

