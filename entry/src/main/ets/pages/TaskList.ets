/**
 * ä»»åŠ¡åˆ—è¡¨é¡µé¢
 */

import router from '@ohos.router'
import { Colors, TaskStatus, TaskPriority } from '../utils/Constants'
import { DatabaseManager } from '../database/DatabaseManager'
import { Task } from '../models/Task'
import { DateUtils } from '../utils/DateUtils'

@Entry
@Component
struct TaskList {
  @State tasks: Task[] = []
  @State filteredTasks: Task[] = []
  @State currentFilter: string = 'å…¨éƒ¨'
  @State searchText: string = ''
  private dbManager: DatabaseManager | null = null
  private filterStatus: string = ''

  async aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>
    if (params && params.status) {
      this.filterStatus = params.status as string
      this.currentFilter = this.filterStatus
    }

    // åˆå§‹åŒ–æ•°æ®åº“
    this.dbManager = DatabaseManager.getInstance(getContext(this))
    await this.loadTasks()
  }

  /**
   * åŠ è½½ä»»åŠ¡åˆ—è¡¨
   */
  async loadTasks() {
    if (!this.dbManager) return

    if (this.filterStatus) {
      this.tasks = await this.dbManager.queryTasksByStatus(this.filterStatus)
    } else {
      this.tasks = await this.dbManager.queryAllTasks()
    }
    
    this.filteredTasks = this.tasks
  }

  /**
   * ç­›é€‰ä»»åŠ¡
   */
  filterTasks(status: string) {
    this.currentFilter = status
    
    if (status === 'å…¨éƒ¨') {
      this.filteredTasks = this.tasks
    } else {
      this.filteredTasks = this.tasks.filter(task => task.status === status)
    }
  }

  /**
   * æœç´¢ä»»åŠ¡
   */
  searchTasks(keyword: string) {
    this.searchText = keyword
    
    if (!keyword) {
      this.filteredTasks = this.tasks
      return
    }

    this.filteredTasks = this.tasks.filter(task => 
      task.taskName.includes(keyword) ||
      task.assignerName.includes(keyword) ||
      task.assigneeName.includes(keyword) ||
      task.taskDescription.includes(keyword)
    )
  }

  /**
   * å¯¼èˆªåˆ°ä»»åŠ¡è¯¦æƒ…
   */
  navigateToTaskDetail(taskId: number) {
    router.pushUrl({
      url: 'pages/TaskDetail',
      params: { taskId: taskId }
    })
  }

  /**
   * å¯¼èˆªåˆ°åˆ›å»ºä»»åŠ¡
   */
  navigateToCreateTask() {
    router.pushUrl({
      url: 'pages/TaskCreate'
    })
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  goBack() {
    router.back()
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle }) {
          Text('â†')
            .fontSize(24)
            .fontColor(Colors.TEXT_WHITE)
        }
        .width(40)
        .height(40)
        .backgroundColor('rgba(255, 255, 255, 0.2)')
        .onClick(() => this.goBack())

        Text('ä»»åŠ¡åˆ—è¡¨')
          .fontSize(22)
          .fontWeight(600)
          .fontColor(Colors.TEXT_WHITE)
          .margin({ left: 15 })
        
        Blank()

        Button({ type: ButtonType.Circle }) {
          Text('â•')
            .fontSize(20)
            .fontColor(Colors.TEXT_WHITE)
        }
        .width(40)
        .height(40)
        .backgroundColor('rgba(255, 255, 255, 0.2)')
        .onClick(() => this.navigateToCreateTask())
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 15, bottom: 15 })
      .linearGradient({
        angle: 135,
        colors: [[Colors.BG_GRADIENT_START, 0.0], [Colors.BG_GRADIENT_END, 1.0]]
      })

      // æœç´¢æ¡†
      Row() {
        TextInput({ placeholder: 'æœç´¢ä»»åŠ¡ã€äººå‘˜...' })
          .width('100%')
          .height(45)
          .fontSize(15)
          .backgroundColor(Colors.BG_CARD)
          .borderRadius(22)
          .padding({ left: 45, right: 15 })
          .onChange((value: string) => this.searchTasks(value))
        
        Text('ğŸ”')
          .fontSize(20)
          .position({ x: 15, y: 12 })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 15, bottom: 10 })
      .backgroundColor(Colors.BG_PRIMARY)

      // ç­›é€‰æ ‡ç­¾
      Row() {
        this.FilterChip('å…¨éƒ¨', this.currentFilter === 'å…¨éƒ¨')
        this.FilterChip(TaskStatus.NOT_STARTED, this.currentFilter === TaskStatus.NOT_STARTED)
        this.FilterChip(TaskStatus.IN_PROGRESS, this.currentFilter === TaskStatus.IN_PROGRESS)
        this.FilterChip(TaskStatus.COMPLETED, this.currentFilter === TaskStatus.COMPLETED)
        this.FilterChip(TaskStatus.OVERDUE, this.currentFilter === TaskStatus.OVERDUE)
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 5, bottom: 15 })
      .backgroundColor(Colors.BG_PRIMARY)

      // ä»»åŠ¡åˆ—è¡¨
      if (this.filteredTasks.length === 0) {
        Column() {
          Text('ğŸ“­')
            .fontSize(60)
            .margin({ bottom: 15 })
          
          Text('æš‚æ— ä»»åŠ¡')
            .fontSize(16)
            .fontColor(Colors.TEXT_SECONDARY)
          
          Text(this.searchText ? 'è¯•è¯•å…¶ä»–æœç´¢å…³é”®è¯' : 'ç‚¹å‡»å³ä¸Šè§’åˆ›å»ºæ–°ä»»åŠ¡')
            .fontSize(14)
            .fontColor(Colors.TEXT_LIGHT)
            .margin({ top: 8 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(Colors.BG_PRIMARY)
      } else {
        List({ space: 12 }) {
          ForEach(this.filteredTasks, (task: Task) => {
            ListItem() {
              this.TaskCard(task)
            }
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20, bottom: 20 })
        .layoutWeight(1)
        .backgroundColor(Colors.BG_PRIMARY)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Colors.BG_PRIMARY)
  }

  /**
   * ç­›é€‰æ ‡ç­¾ç»„ä»¶
   */
  @Builder
  FilterChip(label: string, isActive: boolean) {
    Text(label)
      .fontSize(13)
      .fontColor(isActive ? Colors.TEXT_WHITE : Colors.TEXT_SECONDARY)
      .padding({ left: 14, right: 14, top: 7, bottom: 7 })
      .backgroundColor(isActive ? Colors.PRIMARY_START : Colors.BG_CARD)
      .borderRadius(16)
      .margin({ right: 8 })
      .onClick(() => this.filterTasks(label))
  }

  /**
   * ä»»åŠ¡å¡ç‰‡ç»„ä»¶
   */
  @Builder
  TaskCard(task: Task) {
    Column() {
      // ä»»åŠ¡æ ‡é¢˜å’ŒçŠ¶æ€
      Row() {
        Column() {
          Text(task.taskName)
            .fontSize(17)
            .fontWeight(600)
            .fontColor(Colors.TEXT_PRIMARY)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        
        Text(task.status)
          .fontSize(12)
          .fontColor(Colors.TEXT_WHITE)
          .padding({ left: 10, right: 10, top: 5, bottom: 5 })
          .backgroundColor(this.getStatusColor(task.status))
          .borderRadius(10)
          .margin({ left: 10 })
      }
      .width('100%')
      .margin({ bottom: 12 })

      // ä»»åŠ¡æè¿°
      if (task.taskDescription) {
        Text(task.taskDescription)
          .fontSize(14)
          .fontColor(Colors.TEXT_SECONDARY)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .margin({ bottom: 12 })
      }

      // äººå‘˜ä¿¡æ¯
      Row() {
        Row() {
          Text('ğŸ‘¤')
            .fontSize(14)
            .margin({ right: 4 })
          
          Text(task.assignerName)
            .fontSize(13)
            .fontColor(Colors.TEXT_SECONDARY)
        }

        Text('â†’')
          .fontSize(13)
          .fontColor(Colors.TEXT_LIGHT)
          .margin({ left: 8, right: 8 })
        
        Row() {
          Text('ğŸ¯')
            .fontSize(14)
            .margin({ right: 4 })
          
          Text(task.assigneeName)
            .fontSize(13)
            .fontColor(Colors.TEXT_SECONDARY)
        }

        Blank()

        Text(task.priority)
          .fontSize(11)
          .fontColor(this.getPriorityColor(task.priority))
          .padding({ left: 8, right: 8, top: 3, bottom: 3 })
          .border({
            width: 1,
            color: this.getPriorityColor(task.priority),
            radius: 8
          })
      }
      .width('100%')
      .margin({ bottom: 10 })

      // æ—¶é—´ä¿¡æ¯
      Row() {
        Text('ğŸ“… ' + DateUtils.formatDate(task.assignTime, 'MMæœˆDDæ—¥'))
          .fontSize(12)
          .fontColor(Colors.TEXT_LIGHT)
        
        Blank()
        
        Text('â° ' + DateUtils.getRemainingTimeText(task.planFinishTime))
          .fontSize(12)
          .fontColor(task.isOverdue() ? Colors.STATUS_OVERDUE : Colors.TEXT_SECONDARY)
          .fontWeight(task.isOverdue() ? 600 : 400)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Colors.BG_CARD)
    .borderRadius(14)
    .shadow({
      radius: 8,
      color: 'rgba(0, 0, 0, 0.08)',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => this.navigateToTaskDetail(task.id))
  }

  /**
   * è·å–çŠ¶æ€é¢œè‰²
   */
  getStatusColor(status: string): string {
    switch (status) {
      case TaskStatus.NOT_STARTED:
        return Colors.STATUS_NOT_STARTED
      case TaskStatus.IN_PROGRESS:
        return Colors.STATUS_IN_PROGRESS
      case TaskStatus.COMPLETED:
        return Colors.STATUS_COMPLETED
      case TaskStatus.OVERDUE:
        return Colors.STATUS_OVERDUE
      default:
        return Colors.STATUS_NOT_STARTED
    }
  }

  /**
   * è·å–ä¼˜å…ˆçº§é¢œè‰²
   */
  getPriorityColor(priority: string): string {
    switch (priority) {
      case 'ä½':
        return Colors.PRIORITY_LOW
      case 'ä¸­':
        return Colors.PRIORITY_MEDIUM
      case 'é«˜':
        return Colors.PRIORITY_HIGH
      case 'ç´§æ€¥':
        return Colors.PRIORITY_URGENT
      default:
        return Colors.PRIORITY_MEDIUM
    }
  }
}

