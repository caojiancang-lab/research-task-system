# V2.7.1 修复更新文档

## 📋 更新概述

本次更新主要修复了用户权限设置、人员任务显示问题，并添加了新的管理员账号。

**更新日期**: 2026年1月21日  
**版本号**: V2.7.1  
**更新类型**: 问题修复 + 功能优化

---

## ✨ 主要更新内容

### 1. 🔒 用户角色和权限严格限制

**问题描述**：
- 之前注册用户时可以选择角色
- 权限设置不够精确

**解决方案**：
- ✅ 注册时用户角色**强制固定为"普通用户"**
- ✅ 角色选择框被禁用和隐藏
- ✅ 权限严格限制为：
  - **查看任务** ✅
  - **编辑科研进展** ✅（仅限科研进展类型的任务）
  - 其他权限 ❌

**权限详情**：

| 权限类型 | 管理员 | 普通用户（新） |
|---------|--------|--------------|
| 创建任务 | ✅ | ❌ |
| 编辑任务 | ✅ | ✅（仅科研进展） |
| 删除任务 | ✅ | ❌ |
| 查看任务 | ✅ | ✅ |
| 数据分析 | ✅ | ❌ |
| 导出数据 | ✅ | ❌ |

**编辑限制说明**：
- 普通用户虽然有"编辑"权限
- 但**只能编辑"科研进展"类型的任务**
- 尝试编辑其他类型任务会提示：`您只能编辑科研进展类型的任务！`

---

### 2. 🐛 修复人员任务显示问题

**问题描述**：
- 在管理员系统的"人员任务"中显示已删除的任务
- 导致任务数量统计不准确

**解决方案**：
- ✅ 增强任务过滤逻辑，排除无效任务
- ✅ 添加任务清理功能，自动移除无效数据
- ✅ 确保只显示有效的任务

**修复内容**：
```javascript
// 过滤任务时确保任务存在且有ID
let filteredTasks = this.tasks.filter(t => t && t.id);

// 清理无效任务
cleanupTasks() {
    const validTasks = this.tasks.filter(t => t && t.id && t.name);
    // 移除无效任务
}
```

---

### 3. 👑 添加新管理员账号

**新增管理员**：
- **账号（学号）**: 18109316679
- **密码**: zxcvbnm9988@
- **角色**: 管理员
- **权限**: 全部权限

**自动添加**：
- ✅ 系统启动时自动检查并添加
- ✅ 如果账号已存在则跳过
- ✅ 无需手动操作

**使用方法**：
```
1. 打开登录页面
2. 输入账号：18109316679
3. 输入密码：zxcvbnm9988@
4. 点击登录
```

---

## 🎯 功能详解

### 用户注册流程

**管理员添加用户**：
```
1. 进入管理后台
2. 点击"+ 添加用户"
3. 填写用户信息
4. 角色自动设为"普通用户"（不可修改）
5. 权限自动设为"查看任务"和"编辑任务"
6. 保存
```

**权限说明**：
- 新用户可以查看所有任务
- 新用户只能编辑科研进展类型的任务
- 新用户不能创建、删除任务
- 新用户不能查看数据分析
- 新用户不能导出数据

### 编辑权限控制

**场景1：编辑科研进展任务**
```
1. 普通用户打开科研进展任务详情
2. 点击"编辑"按钮
3. 可以正常编辑 ✅
4. 保存成功
```

**场景2：尝试编辑其他类型任务**
```
1. 普通用户打开"数据分析"类型任务详情
2. 点击"编辑"按钮
3. 系统提示：您只能编辑科研进展类型的任务！ ❌
4. 无法编辑
```

### 人员任务查看

**修复后的显示**：
- ✅ 只显示有效的任务
- ✅ 任务数量统计准确
- ✅ 不会显示已删除的任务
- ✅ 自动清理无效数据

---

## 🔧 技术细节

### 文件变更

**新增文件**：
- `web/v2.7.1-fixes.js` - V2.7.1修复脚本（约300行）

**修改文件**：
- `web/admin-app.js` - 修复editUser方法中的permissions变量
- `web/advanced-system.html` - 引入新脚本

### 核心功能实现

#### 1. 强制用户角色
```javascript
// 禁用角色选择
role.value = 'user';
role.disabled = true;

// 隐藏角色选择框
roleGroup.style.display = 'none';
```

#### 2. 限制编辑权限
```javascript
// 检查任务类型
if (task.type !== '科研进展') {
    this.showToast('您只能编辑科研进展类型的任务！', 'error');
    return;
}
```

#### 3. 清理无效任务
```javascript
cleanupTasks() {
    const validTasks = this.tasks.filter(t => t && t.id && t.name);
    this.tasks = validTasks;
    this.saveData();
}
```

#### 4. 添加管理员
```javascript
const newAdmin = {
    studentId: '18109316679',
    password: 'zxcvbnm9988@',
    role: 'admin',
    permissions: { /* 全部权限 */ }
};
```

---

## 📊 版本对比

| 功能 | V2.7 | V2.7.1 |
|------|------|--------|
| 用户角色选择 | ✅ 可选 | ❌ 固定为普通用户 |
| 编辑权限 | ✅ 所有任务 | ✅ 仅科研进展 |
| 人员任务显示 | ❌ 显示已删除任务 | ✅ 只显示有效任务 |
| 管理员账号 | 1个 | 2个 |
| 任务清理 | ❌ 无 | ✅ 自动清理 |

---

## 🎨 界面变化

### 添加用户界面

**之前**：
```
角色：[管理员 ▼] [用户 ▼]  ← 可选择
```

**现在**：
```
角色：普通用户（自动设置）  ← 不显示/禁用
```

### 权限设置

**固定权限**：
```
☐ 创建任务
☑ 编辑任务（仅科研进展）
☐ 删除任务
☑ 查看任务
☐ 数据分析
☐ 导出数据
```

---

## ⚠️ 重要说明

### 关于编辑权限

**普通用户的编辑权限说明**：
- ✅ 可以编辑：科研进展类型的任务
- ❌ 不能编辑：其他类型的任务（实验设计、数据采集、数据分析等）

**为什么这样设计**：
- 科研进展需要学生定期填写和更新
- 其他类型的任务由管理员统一管理
- 避免学生误操作影响任务管理

### 关于角色限制

**为什么不能选择角色**：
- 安全考虑：防止误操作创建管理员账号
- 权限管理：统一的权限控制更安全
- 简化流程：减少选择，降低出错概率

**如何添加管理员**：
- 方法1：直接修改数据库（localStorage）
- 方法2：使用脚本自动添加（如本次更新）
- 方法3：联系系统开发人员

---

## 🧪 测试步骤

### 测试1：用户注册权限
```
1. 管理员登录 → 管理后台
2. 点击"+ 添加用户"
3. 查看角色是否固定为"普通用户"
4. 查看权限是否只有"查看"和"编辑"
5. 保存用户
6. 用新用户登录
7. 尝试创建任务（应该失败）
```

### 测试2：编辑权限限制
```
1. 创建两个任务：
   - 任务A：科研进展类型
   - 任务B：数据分析类型
2. 用普通用户登录
3. 打开任务A → 点击编辑（应该成功）
4. 打开任务B → 点击编辑（应该失败）
```

### 测试3：人员任务显示
```
1. 管理员登录
2. 创建几个任务
3. 删除其中一些任务
4. 进入"人员任务"查看
5. 确认不显示已删除的任务
```

### 测试4：新管理员登录
```
1. 打开登录页面
2. 输入账号：18109316679
3. 输入密码：zxcvbnm9988@
4. 登录成功
5. 确认有管理员权限
```

---

## 🐛 已修复问题

1. ✅ 用户注册时可以选择角色的安全隐患
2. ✅ 普通用户权限过大的问题
3. ✅ 人员任务显示已删除任务的bug
4. ✅ 缺少第二个管理员账号

---

## 📝 注意事项

### 用户管理
- ⚠️ 新用户只能查看和编辑科研进展
- ⚠️ 如需更多权限，管理员需手动授予
- 💡 建议根据实际需要逐步授权

### 编辑限制
- ⚠️ 普通用户只能编辑科研进展类型的任务
- ⚠️ 尝试编辑其他类型会被拒绝
- 💡 这是为了保护任务数据的完整性

### 数据清理
- ✅ 系统会自动清理无效任务
- ✅ 不影响正常任务数据
- 💡 建议定期检查任务列表

### 管理员账号
- 🔐 新管理员账号已自动添加
- 🔐 请妥善保管密码
- 💡 建议首次登录后修改密码

---

## 🚀 立即使用

1. **刷新页面**：确保加载最新脚本
2. **测试新功能**：
   - 添加新用户测试权限
   - 测试编辑权限限制
   - 查看人员任务是否正常
   - 使用新管理员账号登录

---

## 📞 技术支持

如有问题或建议，请联系开发团队。

**系统版本**: V2.7.1  
**更新日期**: 2026年1月21日  
**开发团队**: 神经精神亚专业研究生管理系统

---

## 🔮 后续计划

- [ ] 添加权限申请功能
- [ ] 优化任务数据存储
- [ ] 增加数据备份功能
- [ ] 完善日志记录系统


