# 系统更新文档 V2.7

## 📋 更新概述

本次更新重点优化了权限管理、进度更新流程，并新增了管理员一键完成功能和科研进展周计划系统，使系统更加专业化和规范化。

**更新日期**: 2026年1月21日  
**版本号**: V2.7  
**更新类型**: 功能增强 + 流程优化

---

## ✨ 主要更新内容

### 1. 🔒 普通用户默认权限调整

**变更说明**：
- ❌ **旧版本**：普通用户注册时默认拥有创建、编辑、查看、分析权限
- ✅ **新版本**：普通用户注册时默认只有查看权限

**设计理念**：
- 遵循最小权限原则，提高系统安全性
- 管理员可根据实际需要为用户授予更多权限
- 防止新用户误操作影响系统数据

**权限对比**：

| 权限类型 | 管理员 | 普通用户（新） | 普通用户（旧） |
|---------|--------|--------------|--------------|
| 创建任务 | ✅ | ❌ | ✅ |
| 编辑任务 | ✅ | ❌ | ✅ |
| 删除任务 | ✅ | ❌ | ❌ |
| 查看任务 | ✅ | ✅ | ✅ |
| 数据分析 | ✅ | ❌ | ✅ |
| 导出数据 | ✅ | ❌ | ❌ |

**管理员操作**：
1. 进入管理后台
2. 编辑用户信息
3. 勾选需要授予的权限
4. 保存即可生效

---

### 2. 📊 管理员进度更新优化

**新增功能**：
- ✅ 管理员/指派人更新进度时，弹出专业的进度修改界面
- ✅ 可以直接输入具体的进度数值（0-100）
- ✅ 提供快捷按钮：25%、50%、75%、100%
- ✅ 可以添加进度说明，记录更新原因
- ✅ 自动记录进度历史和更新人

**界面预览**：
```
┌─────────────────────────────────────┐
│ 📊 更新任务进度                     │
├─────────────────────────────────────┤
│ 任务名称：完成数据分析              │
│ 当前进度：30%                       │
│                                     │
│ 新进度值 (%)                        │
│ [    50    ]                        │
│ [25%] [50%] [75%] [100%]           │
│                                     │
│ 进度说明（可选）                    │
│ ┌─────────────────────────────┐   │
│ │ 已完成数据预处理和初步分析  │   │
│ └─────────────────────────────┘   │
│                                     │
│ [取消]              [确认更新]     │
└─────────────────────────────────────┘
```

**使用场景**：
- 📈 定期更新任务进度
- 📝 记录阶段性成果
- 🎯 精确控制进度百分比
- 💬 添加进度说明便于追溯

**自动化功能**：
- 进度达到100%时，自动将状态改为"待审核"
- 记录每次更新的时间、进度值、说明和更新人
- 支持查看完整的进度历史记录

---

### 3. ✅ 管理员一键完成功能

**新增功能**：
- ✅ 管理员在任务详情页可以看到"一键完成"按钮
- ✅ 点击后自动完成以下操作：
  - 进度设为 100%
  - 状态改为"已完成"
  - 记录完成时间
  - 添加进度历史记录

**使用场景**：
- 🚀 快速完成简单任务
- ✅ 批量处理已完成的任务
- 🎯 紧急情况下的快速操作
- 📋 测试和演示时的便捷功能

**安全机制**：
- ⚠️ 仅管理员可见和使用
- ⚠️ 操作前需要二次确认
- ⚠️ 自动记录操作人和时间
- ⚠️ 已完成的任务不显示此按钮

**操作流程**：
```
1. 管理员打开任务详情
2. 点击"✅ 一键完成"按钮
3. 确认操作提示
4. 任务自动完成
```

---

### 4. 📅 科研进展周计划系统

**核心功能**：
这是本次更新的重点功能，专为科研进展任务设计的周计划管理系统。

#### 4.1 功能特点

✅ **三周联动**：上周、本周、下周计划完美衔接  
✅ **时间自动计算**：系统自动识别周一到周日的时间范围  
✅ **权限控制**：普通用户填写，管理员审核  
✅ **审核锁定**：审核后用户无法修改，保证计划的严肃性  
✅ **历史追溯**：记录每次填写和修改的时间及人员

#### 4.2 使用流程

**普通用户填写计划**：
1. 打开科研进展类型的任务详情
2. 点击"📅 周计划"按钮
3. 查看上周计划（只读）
4. 填写本周计划
5. 填写下周计划
6. 点击"保存计划"

**管理员审核计划**：
1. 打开任务详情，点击"📅 周计划"
2. 查看用户提交的本周计划
3. 点击"✅ 审核通过"按钮
4. 审核后用户无法修改该周计划

#### 4.3 界面设计

```
┌─────────────────────────────────────────────┐
│ 📅 科研进展周计划                           │
├─────────────────────────────────────────────┤
│ 任务：科研进展汇报                          │
│ 接收人：张三                                │
│                                             │
│ 📋 上周计划 (2026-01-13 至 2026-01-19)     │
│ ┌─────────────────────────────────────┐   │
│ │ 完成文献综述初稿                    │   │
│ │ 整理实验数据                        │   │
│ └─────────────────────────────────────┘   │
│                                             │
│ ✍️ 本周计划 (2026-01-20 至 2026-01-26)     │
│ ┌─────────────────────────────────────┐   │
│ │ 1. 完成数据分析                     │   │
│ │ 2. 撰写方法部分                     │   │
│ │ 3. 准备中期汇报PPT                  │   │
│ └─────────────────────────────────────┘   │
│                                             │
│ 🎯 下周计划 (2026-01-27 至 2026-02-02)     │
│ ┌─────────────────────────────────────┐   │
│ │ 1. 进行中期汇报                     │   │
│ │ 2. 根据反馈修改论文                 │   │
│ └─────────────────────────────────────┘   │
│                                             │
│ [关闭]                      [保存计划]     │
└─────────────────────────────────────────────┘
```

#### 4.4 时间衔接机制

**自动计算周范围**：
- 系统以周一为一周的开始
- 自动计算上周、本周、下周的起止日期
- 确保时间无缝衔接，不会出现遗漏

**示例**：
```
今天：2026年1月21日（周二）

上周：2026-01-13（周一）至 2026-01-19（周日）
本周：2026-01-20（周一）至 2026-01-26（周日）
下周：2026-01-27（周一）至 2026-02-02（周日）
```

#### 4.5 审核锁定机制

**审核前**：
- ✅ 用户可以随时修改本周和下周计划
- ✅ 可以多次保存和更新
- ✅ 管理员可以查看但不能修改

**审核后**：
- ❌ 用户无法修改已审核的计划
- ✅ 管理员仍可查看和修改
- ⚠️ 页面显示"已审核"标记
- 💡 提示用户联系管理员如需修改

#### 4.6 数据存储

**存储内容**：
```javascript
{
    id: 唯一标识,
    taskId: 任务ID,
    weekStart: 周开始时间戳,
    weekEnd: 周结束时间戳,
    content: 计划内容,
    createTime: 创建时间,
    updateTime: 更新时间,
    createdBy: 创建人,
    updatedBy: 更新人,
    approved: 是否已审核,
    approvedBy: 审核人,
    approvedTime: 审核时间
}
```

---

## 🎯 使用指南

### 场景1：管理员添加新用户

1. 进入管理后台
2. 点击"+ 添加用户"
3. 填写用户信息
4. 选择角色为"用户"
5. 系统自动设置为只有"查看任务"权限
6. 根据需要手动勾选其他权限
7. 保存

### 场景2：管理员更新任务进度

1. 打开任务详情
2. 点击"📊 更新进度"按钮
3. 输入新的进度值或点击快捷按钮
4. 填写进度说明（可选）
5. 点击"确认更新"

### 场景3：管理员一键完成任务

1. 打开任务详情
2. 点击"✅ 一键完成"按钮
3. 确认操作
4. 任务自动完成

### 场景4：用户填写科研进展周计划

1. 打开科研进展类型的任务
2. 点击"📅 周计划"按钮
3. 查看上周计划（参考）
4. 填写本周计划（必填）
5. 填写下周计划（建议填写）
6. 点击"保存计划"

### 场景5：管理员审核周计划

1. 打开任务详情
2. 点击"📅 周计划"按钮
3. 查看用户提交的计划
4. 确认内容无误后点击"✅ 审核通过"
5. 审核后用户无法修改

---

## 🔧 技术细节

### 文件变更

**新增文件**：
- `web/v2.7-improvements.js` - V2.7核心改进脚本（约400行）

**修改文件**：
- `web/admin-app.js` - 修改默认权限设置逻辑
- `web/advanced-system.html` - 引入新脚本

### 核心功能实现

#### 1. 权限控制
```javascript
// 普通用户默认只有查看权限
updatePermissionsByRole() {
    if (role === 'user') {
        view: true,  // 只有查看权限
        其他: false
    }
}
```

#### 2. 进度更新
```javascript
showProgressModalEnhanced(taskId) {
    // 显示进度修改界面
    // 提供数值输入和快捷按钮
    // 记录进度历史
}
```

#### 3. 一键完成
```javascript
quickCompleteTask(taskId) {
    // 检查管理员权限
    // 设置进度100%
    // 状态改为completed
    // 记录完成时间
}
```

#### 4. 周计划系统
```javascript
// 计算周范围
getWeekRange(date) {
    // 以周一为起点
    // 返回起止时间戳
}

// 保存周计划
saveWeeklyPlan(taskId) {
    // 保存本周和下周计划
    // 记录时间和人员
}

// 审核周计划
approveWeeklyPlan(taskId, weekStart) {
    // 设置审核标记
    // 锁定修改权限
}
```

---

## 📊 功能对比

| 功能 | V2.6 | V2.7 |
|------|------|------|
| 普通用户默认权限 | 创建、编辑、查看、分析 | 仅查看 |
| 进度更新方式 | 简单输入 | 专业界面+快捷按钮 |
| 进度说明 | ❌ 无 | ✅ 支持 |
| 一键完成 | ❌ 无 | ✅ 管理员专用 |
| 周计划系统 | ❌ 无 | ✅ 完整系统 |
| 计划审核 | ❌ 无 | ✅ 审核锁定 |
| 时间衔接 | ❌ 无 | ✅ 自动计算 |

---

## 🎨 界面优化

### 新增按钮样式

**📊 更新进度按钮**：
- 蓝色主题
- 管理员和指派人可见

**✅ 一键完成按钮**：
- 绿色主题
- 仅管理员可见
- 已完成任务不显示

**📅 周计划按钮**：
- 紫色主题
- 仅科研进展任务显示
- 所有相关人员可见

---

## 🔒 安全性提升

1. **最小权限原则**：新用户默认最小权限
2. **操作确认**：一键完成需要二次确认
3. **审核锁定**：审核后计划无法随意修改
4. **操作记录**：所有关键操作都有日志
5. **权限检查**：每个功能都有严格的权限验证

---

## 📝 注意事项

### 权限管理
- ⚠️ 新注册用户默认只有查看权限
- ⚠️ 管理员需要手动授予其他权限
- ⚠️ 建议根据实际需要逐步授权

### 进度更新
- 💡 进度说明虽然可选，但建议填写
- 💡 进度历史会永久保存
- 💡 进度达到100%会自动改为待审核状态

### 一键完成
- ⚠️ 此功能仅用于特殊情况
- ⚠️ 建议优先使用正常的进度更新流程
- ⚠️ 操作不可撤销，请谨慎使用

### 周计划系统
- 📅 每周一次，建议周一填写
- 📅 审核后无法修改，填写前请仔细检查
- 📅 上周计划会自动显示，便于参考
- 📅 建议提前规划下周计划

---

## 🐛 已修复问题

1. ✅ 新用户权限过大的安全隐患
2. ✅ 进度更新不够灵活
3. ✅ 缺少快速完成任务的方式
4. ✅ 科研进展缺少规范的计划管理

---

## 🚀 测试建议

### 测试权限控制
1. 创建新用户，检查默认权限
2. 尝试用普通用户创建任务（应该失败）
3. 管理员授予权限后再次尝试

### 测试进度更新
1. 打开任务详情
2. 点击"更新进度"按钮
3. 测试数值输入和快捷按钮
4. 添加进度说明并保存
5. 查看进度历史记录

### 测试一键完成
1. 用管理员账号登录
2. 打开未完成的任务
3. 点击"一键完成"按钮
4. 确认任务状态变为已完成

### 测试周计划系统
1. 创建科研进展类型的任务
2. 用普通用户填写周计划
3. 保存后查看是否正确显示
4. 用管理员审核计划
5. 审核后尝试修改（应该被锁定）
6. 下周再次填写，检查时间衔接

---

## 🔮 后续计划

- [ ] 周计划统计和分析
- [ ] 周计划导出功能
- [ ] 批量审核周计划
- [ ] 周计划提醒功能
- [ ] 进度趋势图表

---

## 📞 技术支持

如有问题或建议，请联系开发团队。

**系统版本**: V2.7  
**更新日期**: 2026年1月21日  
**开发团队**: 神经精神亚专业研究生管理系统


